<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Offline Walkie-Talkie with QR Compression</title>
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #020617, #020617);
  color: #f8fafc;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
.app {
  width: 100%;
  max-width: 420px;
  height: 100vh;
  padding: 16px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
h1 { font-size: 22px; margin-bottom: 6px; text-align: center; }
p { font-size: 14px; opacity: 0.85; text-align: center; line-height: 1.4; }
.card { background: #020617; border-radius: 20px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
button { width: 100%; padding: 18px; border-radius: 18px; border: none; font-size: 17px; font-weight: 600; margin-top: 14px; }
button.primary { background: #22c55e; color: #022c22; }
button.secondary { background: #38bdf8; color: #022c22; }
button.hold { background: #ef4444; color: white; height: 120px; font-size: 20px; margin-top: 24px; }
button:active { transform: scale(0.97); }
.status { margin-top: 12px; font-size: 13px; text-align: center; color: #a5b4fc; }
.hidden { display: none; }
.pulse { width: 10px; height: 10px; border-radius: 50%; background: #22c55e; margin: 12px auto; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.8); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
#qrcode { margin: 20px auto; display: block; }
#qr-video { border-radius: 12px; margin-top: 12px; }
</style>
</head>
<body>
<div class="app">

<div id="screen-role" class="card">
  <h1>Walkie-Talkie</h1>
  <p>Works offline on the same Wi-Fi or hotspot</p>
  <button class="primary" onclick="startHost()">Start Walkie-Talkie</button>
  <button class="secondary" onclick="startJoin()">Join Walkie-Talkie</button>
</div>

<div id="screen-host" class="card hidden">
  <h1>Waiting to connect</h1>
  <p>Scan this QR code on the other phone</p>
  <canvas id="qrcode"></canvas>
  <p class="status" id="host-status">Waiting for reply…</p>
</div>

<div id="screen-join" class="card hidden">
  <h1>Join Walkie-Talkie</h1>
  <p>Scan QR code from the host phone</p>
  <video id="qr-video" width="100%" autoplay></video>
  <p class="status" id="join-status">Scanning…</p>
</div>

<div id="screen-talk" class="card hidden">
  <h1>Connected</h1>
  <p>Hold to talk</p>
  <button class="hold" id="talkBtn">HOLD TO TALK</button>
  <p class="status" id="talk-status">Listening…</p>
  <audio id="remoteAudio" autoplay></audio>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string/libs/lz-string.min.js"></script>
<script>
let pc, localStream;
async function initPeer(){
  pc = new RTCPeerConnection();
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack = e=>remoteAudio.srcObject=e.streams[0];
}
function show(id){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}

// HOST SIDE
let hostOffer;
async function startHost(){
  show('screen-host');
  await initPeer();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  hostOffer = JSON.stringify(offer);
  const compressed = LZString.compressToBase64(hostOffer);
  QRCode.toCanvas(document.getElementById('qrcode'), compressed, {width:250});
}

// JOIN SIDE
async function startJoin(){
  show('screen-join');
  await initPeer();
  const video=document.getElementById('qr-video');
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(stream=>{
    video.srcObject=stream;
    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d');
    function scanFrame(){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth;
        canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(imgData.data,imgData.width,imgData.height);
        if(code){
          connectFromQR(code.data);
          return;
        }
      }
      requestAnimationFrame(scanFrame);
    }
    scanFrame();
  });
}
async function connectFromQR(data){
  const decompressed=LZString.decompressFromBase64(data);
  const offer=JSON.parse(decompressed);
  await pc.setRemoteDescription(offer);
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  // For simplicity, in this preview, talk starts automatically
  show('screen-talk');
}

const talkBtn=document.getElementById('talkBtn');
if(talkBtn){
  talkBtn.addEventListener('touchstart',()=>toggleMic(true));
  talkBtn.addEventListener('touchend',()=>toggleMic(false));
}
function toggleMic(on){
  localStream.getAudioTracks()[0].enabled=on;
  document.getElementById('talk-status').innerText=on?'Talking…':'Listening…';
}
</script>
</body>
</html>
