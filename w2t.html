<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Offline Walkie-Talkie with Two-Way QR</title>
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #020617, #020617);
  color: #f8fafc;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
.app {
  width: 100%;
  max-width: 420px;
  height: 100vh;
  padding: 16px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
h1 { font-size: 22px; margin-bottom: 6px; text-align: center; }
p { font-size: 14px; opacity: 0.85; text-align: center; line-height: 1.4; }
.card { background: #020617; border-radius: 20px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
button { width: 100%; padding: 18px; border-radius: 18px; border: none; font-size: 17px; font-weight: 600; margin-top: 14px; cursor:pointer; }
button.primary { background: #22c55e; color: #022c22; }
button.secondary { background: #38bdf8; color: #022c22; }
button.hold { background: #ef4444; color: white; height: 120px; font-size: 20px; margin-top: 24px; }
button.disconnect { background: #f87171; color: white; }
button.scanAnswer { background: #fbbf24; color: #022c22; }
button:active { transform: scale(0.97); }
.status { margin-top: 12px; font-size: 13px; text-align: center; color: #a5b4fc; }
.hidden { display: none; }
#qrcode, #answerQR { margin: 20px auto; display: block; padding: 10px; background: #fff; }
#qr-video, #scan-video { border-radius: 12px; margin-top: 12px; }
input[type=range] { width: 100%; margin-top: 12px; }
</style>
</head>
<body>
<div class="app">

<div id="screen-role" class="card">
  <h1>Walkie-Talkie</h1>
  <p>Works offline on the same Wi-Fi or hotspot</p>
  <button class="primary" onclick="startHost()">Start Walkie-Talkie</button>
  <button class="secondary" onclick="startJoin()">Join Walkie-Talkie</button>
</div>

<div id="screen-host" class="card hidden">
  <h1>Waiting to connect</h1>
  <p>Scan this QR code on the other phone</p>
  <canvas id="qrcode"></canvas>
  <button class="scanAnswer" onclick="scanAnswerFromJoin()" style="display:block; margin:12px auto;">Scan Answer QR</button>
  <video id="scan-video" width="100%" autoplay class="hidden" style="margin-top:12px;"></video>
  <input type="range" id="zoomSlider" min="1" max="1" step="0.1" value="1" class="hidden">
  <p class="status" id="host-status">Waiting for reply…</p>
</div>

<div id="screen-join" class="card hidden">
  <h1>Join Walkie-Talkie</h1>
  <p>Scan QR code from the host phone</p>
  <video id="qr-video" width="100%" autoplay></video>
  <input type="range" id="joinZoomSlider" min="1" max="1" step="0.1" value="1" class="hidden">
  <p class="status" id="join-status">Scanning…</p>
  <p>Show this QR to the host to finish connecting</p>
  <canvas id="answerQR"></canvas>
</div>

<div id="screen-talk" class="card hidden">
  <h1>Connected</h1>
  <p>Hold to talk</p>
  <button class="hold" id="talkBtn">HOLD TO TALK</button>
  <button class="disconnect" onclick="disconnect()">Disconnect</button>
  <p class="status" id="talk-status">Listening…</p>
  <audio id="remoteAudio" autoplay></audio>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string/libs/lz-string.min.js"></script>
<script>
let pc, localStream, scanStream;
let track;
async function initPeer(){
  pc = new RTCPeerConnection();
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack = e=>remoteAudio.srcObject=e.streams[0];
}
function show(id){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}

// HOST SIDE
let hostOffer;
async function startHost(){
  show('screen-host');
  await initPeer();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  hostOffer = JSON.stringify(offer);
  const compressed = LZString.compressToBase64(hostOffer);

  const qrCanvas = document.getElementById('qrcode');
  qrCanvas.width = 250;
  qrCanvas.height = 250;
  qrCanvas.classList.remove('hidden');

  setTimeout(() => {
    QRCode.toCanvas(qrCanvas, compressed, { width: 250, margin: 10 }, function(error){
      if(error) console.error('QR generation error:', error);
      else console.log('QR code generated successfully');
    });
  }, 100);
}

async function scanAnswerFromJoin(){
  const video = document.getElementById('scan-video');
  video.classList.remove('hidden');
  scanStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  video.srcObject = scanStream;
  track = scanStream.getVideoTracks()[0];

  const zoomSlider = document.getElementById('zoomSlider');
  if(track){
    const capabilities = track.getCapabilities();
    if(capabilities.zoom){
      zoomSlider.min = capabilities.zoom.min;
      zoomSlider.max = capabilities.zoom.max;
      zoomSlider.step = capabilities.zoom.step || 0.1;
      zoomSlider.value = track.getSettings().zoom || capabilities.zoom.min;
      zoomSlider.classList.remove('hidden');
      zoomSlider.oninput = () => {
        try{ track.applyConstraints({advanced:[{zoom:parseFloat(zoomSlider.value)}]}); }
        catch(e){ console.warn('Zoom error', e); }
      };
    } else zoomSlider.classList.add('hidden');
  }

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  function scanFrame(){
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imgData.data,imgData.width,imgData.height);
      if(code){ completeConnectionFromAnswer(code.data); return; }
    }
    requestAnimationFrame(scanFrame);
  }
  scanFrame();
}

async function completeConnectionFromAnswer(answerData){
  const decompressed=LZString.decompressFromBase64(answerData);
  const answer=JSON.parse(decompressed);
  await pc.setRemoteDescription(answer);
  show('screen-talk');
  if(scanStream){scanStream.getTracks().forEach(t=>t.stop());}
  document.getElementById('zoomSlider').classList.add('hidden');
}

// JOIN SIDE
async function startJoin(){
  show('screen-join');
  await initPeer();
  const video=document.getElementById('qr-video');
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(stream=>{
    video.srcObject=stream;
    const track = stream.getVideoTracks()[0];
    const joinZoomSlider = document.getElementById('joinZoomSlider');
    const capabilities = track.getCapabilities();
    if(capabilities.zoom){
      joinZoomSlider.min = capabilities.zoom.min;
      joinZoomSlider.max = capabilities.zoom.max;
      joinZoomSlider.step = capabilities.zoom.step || 0.1;
      joinZoomSlider.value = track.getSettings().zoom || capabilities.zoom.min;
      joinZoomSlider.classList.remove('hidden');
      joinZoomSlider.oninput = () => {
        track.applyConstraints({advanced:[{zoom:parseFloat(joinZoomSlider.value)}]});
      };
    }

    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d');
    function scanFrame(){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth;
        canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(imgData.data,imgData.width,imgData.height);
        if(code){ createAnswerQR(code.data); return; }
      }
      requestAnimationFrame(scanFrame);
    }
    scanFrame();
  });
}

async function createAnswerQR(data){
  const decompressed=LZString.decompressFromBase64(data);
  const offer=JSON.parse(decompressed);
  await pc.setRemoteDescription(offer);
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  const answerCompressed=LZString.compressToBase64(JSON.stringify(answer));

  const qrCanvas = document.getElementById('answerQR');
  qrCanvas.width = 250;
  qrCanvas.height = 250;
  qrCanvas.classList.remove('hidden');

  setTimeout(() => {
    QRCode.toCanvas(qrCanvas, answerCompressed, {width:250, margin:10}, function(err){
      if(err) console.error('Answer QR generation error:',err);
    });
  }, 100);

  document.getElementById('join-status').innerText='Show this QR to the host to complete connection';
  pc.onconnectionstatechange = ()=>{if(pc.connectionState==='connected') show('screen-talk');};
}

function disconnect(){
  if(pc){ pc.close(); pc=null; }
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  document.getElementById('zoomSlider').classList.add('hidden');
  document.getElementById('joinZoomSlider').classList.add('hidden');
  show('screen-role');
}

const talkBtn=document.getElementById('talkBtn');
if(talkBtn){
  talkBtn.addEventListener('touchstart',()=>toggleMic(true));
  talkBtn.addEventListener('touchend',()=>toggleMic(false));
}
function toggleMic(on){
  localStream.getAudioTracks()[0].enabled=on;
  document.getElementById('talk-status').innerText=on?'Talking…':'Listening…';
}
</script>
</body>
</html>
